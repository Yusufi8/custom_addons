<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- ================================================= -->
    <!-- My Time Off : LIST VIEW -->
    <!-- ================================================= -->
    <template id="portal_my_timeoff">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">My Time Off</t>
            </t>

            <div class="o_portal_wrap">
                <div class="container mt-4">

                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">My Time Off</h3>
                        <a href="/my/timeoff/new" class="btn btn-primary">
                            <i class="fa fa-plus"/> New Request
                        </a>
                    </div>

                    <!-- List Table -->
                    <table class="table table-hover o_portal_my_doc_table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Leave Type</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Days</th>
                                <th>Status</th>
                                <th>Docs</th>
                                <th>Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                            <t t-foreach="leaves" t-as="leave">
                                <tr>

                                    <!-- Employee -->
                                    <td>
                                        <a t-att-href="'/my/timeoff/%s' % leave.id">
                                            <t t-esc="leave.employee_id.name"/>
                                        </a>
                                    </td>

                                    <!-- Leave Type -->
                                    <td>
                                        <t t-esc="leave.holiday_status_id.name"/>
                                    </td>

                                    <!-- Dates -->
                                    <td>
                                        <t t-esc="leave.request_date_from"/>
                                    </td>
                                    <td>
                                        <t t-esc="leave.request_date_to"/>
                                    </td>

                                    <!-- Days -->
                                    <td>
                                        <t t-esc="leave.number_of_days"/>
                                    </td>

                                    <!-- Status -->
                                    <td>
                                        <t t-if="leave.state == 'validate'">
                                            <span class="badge bg-success">Approved</span>
                                        </t>
                                        <t t-elif="leave.state == 'confirm'">
                                            <span class="badge bg-info">Waiting Approval</span>
                                        </t>
                                        <t t-elif="leave.state == 'draft'">
                                            <span class="badge bg-secondary">To Submit</span>
                                        </t>
                                        <t t-elif="leave.state == 'refuse'">
                                            <span class="badge bg-danger">Refused</span>
                                        </t>
                                    </td>

                                    <!-- Native Supporting Documents Count -->
                                    <td>
                                        <t t-if="attachments_count_map.get(leave.id)">
                                            ðŸ“Ž
                                            <t t-esc="attachments_count_map.get(leave.id)"/>
                                        </t>
                                        <t t-else="">
                                            â€”
                                        </t>
                                    </td>

                                    <!-- Actions -->
                                    <td>
                                        <t t-if="leave.state == 'draft'">
                                            <a t-att-href="'/my/timeoff/delete/%s' % leave.id"
                                               class="btn btn-sm btn-danger"
                                               onclick="return confirm('Are you sure you want to delete this request?')"
                                               title="Delete">
                                                <i class="fa fa-trash"/>
                                            </a>
                                        </t>
                                    </td>

                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <!-- Pager: show only when multiple pages -->
                    <t t-if="pager">
                        <div class="row mt-3">
                            <div class="col text-center">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                 <!-- Prev -->
                                <li t-att-class="'page-item %s' % ('disabled' if pager['page']['num'] == 1 else '')">
                                    <t t-if="pager['page']['num'] == 1">
                                        <span class="page-link">Prev</span>
                                    </t>
                                    <t t-else="">
                                        <a t-att-href="pager['page_previous']['url']" class="page-link">Prev</a>
                                    </t>
                                </li>

                                <!-- Page numbers -->
                                <t t-foreach="pager['pages']" t-as="p">
                                    <li t-att-class="'page-item %s' % ('active' if p['num'] == pager['page']['num'] else '')">
                                        <t t-if="p['num'] == pager['page']['num']">
                                            <span class="page-link"><t t-esc="p['num']"/></span>
                                        </t>
                                        <t t-else="">
                                            <a t-att-href="p['url']" class="page-link"><t t-esc="p['num']"/></a>
                                        </t>
                                    </li>
                                </t>

                                <!-- Next -->
                                <li t-att-class="'page-item %s' % ('disabled' if pager['page']['num'] == pager['page_count'] else '')">
                                    <t t-if="pager['page']['num'] == pager['page_count']">
                                        <span class="page-link">Next</span>
                                    </t>
                                    <t t-else="">
                                        <a t-att-href="pager['page_next']['url']" class="page-link">Next</a>
                                    </t>
                                </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </t>

                    <!-- Debug plain page list (always visible) -->
                    <t t-if="pager">
                        <div class="mt-2 text-center small text-muted">
                            Pages:
                            <t t-foreach="pager['pages']" t-as="p">
                                <t t-if="p['num'] == pager['page']['num']">
                                    <strong><t t-esc="p['num']"/></strong>
                                </t>
                                <t t-else="">
                                    <a t-att-href="p['url']"><t t-esc="p['num']"/></a>
                                </t>
                                <t t-raw="' '"/>
                            </t>
                        </div>
                    </t>

                </div>
            </div>
        </t>
    </template>

    <!-- ================================================= -->
    <!-- My Time Off : DETAILS VIEW -->
    <!-- ================================================= -->
    <template id="portal_timeoff_details">
         <t t-call="portal.portal_layout">

             <div class="container">
                 <div class="row mt-4">
                    <!-- Breadcrumbs: Home / Time Off / Request -->
                    <div class="col-12 mb-2 small text-muted">
                        <a href="/my/home" class="me-2"><i class="fa fa-home"></i> Home</a>
                        / <a href="/my/timeoff" class="ms-2">My Time Off</a>
                    </div>

                     <!-- Main -->
                     <div class="col-lg-9">
                         <div class="card">
                             <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><span t-field="leave.name"/></h5>
                                    <t t-if="form_pager">
                                        <nav aria-label="Record navigation">
                                            <ul class="pagination pagination-sm mb-0">
                                                <li t-att-class="'page-item %s' % ('disabled' if not form_pager.get('prev_url') else '')">
                                                    <t t-if="form_pager.get('prev_url')">
                                                        <a t-att-href="form_pager.get('prev_url')" class="page-link">&#171;</a>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="page-link">&#171;</span>
                                                    </t>
                                                </li>
                                                <li class="page-item disabled"><span class="page-link"> <t t-esc="form_pager.get('index')"/> / <t t-esc="form_pager.get('total')"/> </span></li>
                                                <li t-att-class="'page-item %s' % ('disabled' if not form_pager.get('next_url') else '')">
                                                    <t t-if="form_pager.get('next_url')">
                                                        <a t-att-href="form_pager.get('next_url')" class="page-link">&#187;</a>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="page-link">&#187;</span>
                                                    </t>
                                                </li>
                                            </ul>
                                        </nav>
                                    </t>
                                </div>
                             </div>

                             <div class="card-body">

                                <!-- Employee / Leave Type -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <strong>Employee:</strong>
                                        <div>
                                            <span t-field="leave.employee_id"/>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Leave Type:</strong>
                                        <div>
                                            <span t-field="leave.holiday_status_id"/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dates -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <strong>Start Date:</strong>
                                        <div>
                                            <span t-field="leave.request_date_from"/>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>End Date:</strong>
                                        <div>
                                            <span t-field="leave.request_date_to"/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Days -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <strong>Number of Days:</strong>
                                        <div>
                                            <span t-field="leave.number_of_days"/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Native Supporting Documents -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6>
                                            Supporting Documents
                                            <span class="badge bg-secondary">
                                                <t t-esc="attachments_count"/>
                                            </span>
                                        </h6>

                                        <t t-if="leave.supported_attachment_ids">
                                            <ul class="list-unstyled">
                                                <t t-foreach="leave.supported_attachment_ids" t-as="att">
                                                    <li class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            ðŸ“Ž
                                                            <a t-att-href="'/web/content/%s?download=true' % att.id"
                                                               target="_blank">
                                                                <t t-esc="att.name"/>
                                                            </a>
                                                        </div>
                                                        <t t-if="leave.state in ('draft', 'confirm')">
                                                            <a t-att-href="'/my/timeoff/attachment/delete/%s' % att.id"
                                                               class="btn btn-sm btn-danger"
                                                               onclick="return confirm('Delete this document?')"
                                                               title="Delete">
                                                                <i class="fa fa-trash"/>
                                                            </a>
                                                        </t>
                                                    </li>
                                                </t>
                                            </ul>
                                        </t>

                                        <t t-else="">
                                            <span class="text-muted">No documents</span>
                                        </t>
                                    </div>
                                </div>

                                <!-- Chatter -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6>Messages and Communication History</h6>
                                        <div class="o_portal_chatter" t-att-data-res_model="'hr.leave'" t-att-data-res_id="leave.id">
                                            <t t-call="portal.message_thread">
                                                <t t-set="object" t-value="leave"/>
                                            </t>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <a href="/my/home" class="btn btn-secondary w-100 mb-2">
                                    <i class="fa fa-home"/> Home
                                </a>
                                <a href="/my/timeoff" class="btn btn-secondary w-100">
                                    <i class="fa fa-arrow-left"/> Back
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </t>
    </template>

</odoo>
